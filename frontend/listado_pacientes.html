<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listado de Pacientes - SaludYA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="PIeDePagina/footer.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; font-size: 16px; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      color: #000;
      min-height: 100vh;
    }
    .dark-mode, .dark-mode body {
      background-color: #121212 !important;
      color: #f3f4f6 !important;
    }
    .high-contrast, .high-contrast body {
      background-color: #fffacc !important;
      color: #000 !important;
    }
    .dyslexic-mode {
      font-family: 'OpenDyslexic', sans-serif !important;
    }
    header {
      background-color: #2563eb;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { font-size: 1.6rem; font-weight: bold; }
    .search-bar input {
      padding: 6px 12px;
      border-radius: 20px;
      border: none;
      outline: none;
      width: 250px;
    }
    nav {
      background-color: #1e40af;
    }
    ul.menu {
      list-style: none;
      display: flex;
      padding: 0;
      margin: 0;
    }
    ul.menu > li {
      position: relative;
    }
    ul.menu > li > a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 20px;
      color: white;
      text-decoration: none;
      transition: background 0.3s;
    }
    ul.menu > li:hover > a {
      background-color: #1e3a8a;
      text-decoration: underline;
    }
    ul.submenu {
      position: absolute;
      background-color: #2563eb;
      display: none;
      list-style: none;
      min-width: 180px;
      z-index: 1000;
    }
    ul.menu > li:hover ul.submenu {
      display: block;
    }
    ul.submenu li a {
      display: block;
      padding: 10px 15px;
      color: white;
      text-decoration: none;
    }
    ul.submenu li a:hover {
      background-color: #1e40af;
      text-decoration: underline;
    }
    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .accessibility-wrapper {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
    }
    .accessibility-toggle {
      background-color: #2563eb;
      color: #fff;
      padding: 12px;
      font-size: 20px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .accessibility-menu {
      display: none;
      flex-direction: column;
      margin-top: 10px;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .accessibility-wrapper:hover .accessibility-menu {
      display: flex;
    }
    .accessibility-menu button {
      background-color: #2563eb;
      color: white;
      border: none;
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .subtitulos {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 24px;
      font-size: 17px;
      border-radius: 10px;
      max-width: 80%;
      z-index: 9998;
      display: none;
      text-align: center;
    }

    .paciente-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .paciente-item {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .paciente-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .paciente-item p {
      margin-bottom: 10px;
      font-size: 1rem;
      color: #333;
    }
    .paciente-item strong {
      color: #2563eb;
    }

.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 2000;
  padding: 20px;
}

.modal-card {
  background: #fff;
  padding: 25px;
  width: 90%;
  max-width: 500px;
  max-height: 85vh;
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.3s ease;
  position: relative;
  overflow-y: auto;   /* ✅ Scroll interno si hay mucho contenido */
}

/* Barra de scroll más bonita */
.modal-card::-webkit-scrollbar {
  width: 6px;
}
.modal-card::-webkit-scrollbar-thumb {
  background: #2563eb;
  border-radius: 3px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-card h3 {
  margin-bottom: 15px;
  text-align: center;
  color: #2563eb;
}

.cerrar {
  position: absolute;
  top: 12px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 15px;
}

.form-group label {
  font-weight: bold;
  margin-bottom: 5px;
  color: #333;
}

.form-group input,
.form-group select {
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
  transition: border 0.3s;
}

.form-group input:focus,
.form-group select:focus {
  border-color: #2563eb;
  outline: none;
  box-shadow: 0 0 4px rgba(37, 99, 235, 0.3);
}

.modal-buttons {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.modal-buttons button {
  flex: 1;
  padding: 10px 15px;
  font-size: 1rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: background 0.3s;
  font-weight: bold;
}

.btn-guardar {
  background: #2563eb;
  color: #fff;
}
.btn-guardar:hover { background: #1e40af; }

.btn-eliminar {
  background: #dc3545;
  color: #fff;
}
.btn-eliminar:hover { background: #a71d2a; }

/* ✅ Responsivo para móviles */
@media (max-width: 480px) {
  .modal-card {
    width: 100%;
    max-height: 90vh;
    border-radius: 0;
  }
}

.loader-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  display: none;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #ddd;
  border-top: 5px solid #2563eb;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.filtro-burbuja {
  background: #e5e7eb;
  color: #111;
  padding: 6px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9rem;
  border: 1px solid #ccc;
  transition: all 0.3s ease;
}

.filtro-burbuja:hover {
  background: #2563eb;
  color: #fff;
}

.filtro-burbuja.active {
  background: #2563eb;
  color: #fff;
  border-color: #2563eb;
  font-weight: bold;
}

  </style>
</head>
<body>
<header>
  <div class="logo">SaludYA!</div>
  <div style="display: flex; align-items: center; gap: 20px;">
    <div class="search-bar">
      <input type="text" placeholder="Buscar..." aria-label="Buscar en el sistema">
    </div>
    <button onclick="cerrarSesion()" class="logout-btn">Cerrar sesión</button>
  </div>
</header>

<nav>
  <ul class="menu">
    <li><a href="home.html"><i class="fas fa-home"></i>Inicio</a></li>
    <li><a href="#"><i class="fas fa-user-injured"></i>Pacientes ▾</a>
      <ul class="submenu">
        <li><a href="nuevo_paciente.html"><i class="fas fa-user-plus"></i> Nuevo Paciente</a></li>
        <li><a href="listado_pacientes.html"><i class="fas fa-list"></i> Listado</a></li>
        <li><a href="historial_pacientes.html"><i class="fas fa-history"></i> Historial</a></li>
      </ul>
    </li>
    <li><a href="#"><i class="fas fa-calendar-check"></i>Citas ▾</a>
      <ul class="submenu">
        <li><a href="#"><i class="fas fa-calendar-plus"></i> Agendar</a></li>
        <li><a href="#"><i class="fas fa-edit"></i> Reprogramar</a></li>
      </ul>
    </li>
    <li><a href="#"><i class="fas fa-video"></i>Videollama</a></li>
    <li><a href="#"><i class="fas fa-stethoscope"></i>Consultas</a></li>
    <li><a href="#"><i class="fas fa-headset"></i>Soporte</a></li>
  </ul>
</nav>

<main style="padding: 20px;">
  <h2 tabindex="0" onclick="leerTexto(this)">Listado de Pacientes</h2>
  <p tabindex="0" onclick="leerTexto(this)">Esta es la sección de listado de pacientes registrados en el sistema.</p>

<div id="filtros-burbujas" style="margin: 15px 0; display:flex; gap:10px; flex-wrap:wrap;">
  <span class="filtro-burbuja active" data-filtro="recientes">📅 Más recientes</span>
  <span class="filtro-burbuja" data-filtro="antiguos">📅 Más antiguos</span>
  <span class="filtro-burbuja" data-filtro="az">🔤 Nombres A-Z</span>
  <span class="filtro-burbuja" data-filtro="za">🔤 Nombres Z-A</span>
</div>


  <div id="pacientes-list" class="paciente-container">
    
  </div>
</main>

<div class="accessibility-wrapper">
  <div class="accessibility-toggle" tabindex="0" aria-label="Menú de accesibilidad">♿</div>
  <div class="accessibility-menu" role="menu">
    <button onclick="toggleDarkMode()">🌙 Modo oscuro</button>
    <button onclick="toggleContrast()">🟡 Contraste suave</button>
    <button onclick="toggleDyslexic()">🔤 Modo disléxico</button>
    <button onclick="adjustFont(2)">🔼 Aumentar letra</button>
    <button onclick="adjustFont(-2)">🔽 Disminuir letra</button>
    <button onclick="leerTextoSeleccionado()">🔊 Leer selección</button>
    <button onclick="leerTodo()">📖 Leer todo</button>
  </div>
</div>

<div class="subtitulos" id="subtitulos" aria-live="polite" aria-atomic="true"></div>
<!-- Modal de edición y eliminación -->
<div id="modal-editar" class="modal">
  <div class="modal-card">
    <span class="cerrar" id="cerrar-modal">&times;</span>
    <h3>✏️ Editar Paciente</h3>
    
    <form id="form-editar">
      <input type="hidden" id="edit-id">

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" id="edit-nombre" required>
      </div>

      <div class="form-group">
        <label>Apellido:</label>
        <input type="text" id="edit-apellido" required>
      </div>

      <div class="form-group">
        <label>Cédula:</label>
        <input type="text" id="edit-cedula" required>
      </div>

      <div class="form-group">
        <label>Sexo:</label>
        <select id="edit-sexo" required>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label>Edad:</label>
        <input type="number" id="edit-edad" required>
      </div>

      <div class="form-group">
        <label>Celular:</label>
        <input type="text" id="edit-celular" required>
      </div>

      <div class="form-group">
        <label>Correo:</label>
        <input type="email" id="edit-correo" required>
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn-guardar">💾 Guardar</button>
        <button type="button" id="btn-eliminar" class="btn-eliminar">🗑️ Eliminar</button>
      </div>
    </form>
  </div>
</div>


<!-- Mensaje de éxito -->
<div id="mensaje-exito" class="mensaje-exito" aria-live="polite" aria-atomic="true"></div>

<div id="loader" class="loader-overlay">
  <div class="spinner"></div>
</div>



<div id="footer"></div>

<script>
const modal = document.getElementById("modal-editar");
const cerrarModal = document.getElementById("cerrar-modal");
const formEditar = document.getElementById("form-editar");
const mensajeExito = document.getElementById("mensaje-exito");

function mostrarLoader() {
  document.getElementById("loader").style.display = "flex";
}

function ocultarLoader() {
  document.getElementById("loader").style.display = "none";
}


  function cerrarSesion() {
    window.location.href = "login.html";
  }

  function toggleDarkMode() {
    document.body.classList.remove("high-contrast");
    document.body.classList.toggle("dark-mode");
  }

  function toggleContrast() {
    document.body.classList.remove("dark-mode");
    document.body.classList.toggle("high-contrast");
  }

  function toggleDyslexic() {
    document.body.classList.toggle("dyslexic-mode");
  }

  function adjustFont(change) {
    const html = document.documentElement;
    let size = parseFloat(getComputedStyle(html).fontSize);
    size = Math.max(12, Math.min(24, size + change));
    html.style.fontSize = size + "px";
  }

  function leerTextoSeleccionado() {
    const seleccion = window.getSelection().toString().trim();
    if (seleccion) leerTextoDesdeCadena(seleccion);
    else alert("Selecciona un texto para leer.");
  }

  function leerTodo() {
    leerTextoDesdeCadena(document.body.innerText);
  }

  function leerTexto(elemento) {
    leerTextoDesdeCadena(elemento.innerText || elemento.textContent);
  }

  function leerTextoDesdeCadena(texto) {
    if (!texto) return;
    const subtitulo = document.getElementById("subtitulos");
    subtitulo.innerText = texto;
    subtitulo.style.display = "block";
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(texto);
    utterance.lang = "es-ES";
    speechSynthesis.speak(utterance);
    utterance.onend = () => subtitulo.style.display = "none";
  }

  document.addEventListener('DOMContentLoaded', async () => {
     mostrarLoader();
    try {
      const response = await fetch('/api/pacientes'); 
      const pacientes = await response.json();
      
      if (response.ok) {
        const pacientesContainer = document.getElementById('pacientes-list');
        pacientes.forEach(paciente => {
          const pacienteItem = document.createElement('div');
          pacienteItem.classList.add('paciente-item');
          pacienteItem.innerHTML = `
            <p><strong>Nombre:</strong> ${paciente.nombres} ${paciente.apellidos}</p>
            <p><strong>Cédula:</strong> ${paciente.cedula}</p>
            <p><strong>Sexo:</strong> ${paciente.sexo}</p>
            <p><strong>Edad:</strong> ${paciente.edad}</p>
            <p><strong>Celular:</strong> ${paciente.celular}</p>
            <p><strong>Correo:</strong> ${paciente.correo}</p>
          `;
          pacienteItem.addEventListener("click", () => mostrarModal(paciente));

          pacientesContainer.appendChild(pacienteItem);
        });
      } else {
        console.error('Error al cargar los pacientes');
      }
    } catch (error) {
      console.error('Error al obtener los pacientes:', error);
    } finally {
    ocultarLoader();
  }


  });

  fetch("PieDePagina/footer.html")
    .then(response => response.text())
    .then(data => {
      document.getElementById("footer").innerHTML = data;
    });

    const btnEliminar = document.getElementById("btn-eliminar");
let pacienteActual = null; 

function mostrarModal(paciente) {
  pacienteActual = paciente;
  document.getElementById("edit-id").value = paciente.id;
  document.getElementById("edit-nombre").value = paciente.nombres;
  document.getElementById("edit-apellido").value = paciente.apellidos;
  document.getElementById("edit-cedula").value = paciente.cedula;
  document.getElementById("edit-sexo").value = paciente.sexo;
  document.getElementById("edit-edad").value = paciente.edad;
  document.getElementById("edit-celular").value = paciente.celular;
  document.getElementById("edit-correo").value = paciente.correo;

  modal.style.display = "flex";
}

cerrarModal.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

formEditar.addEventListener("submit", async (e) => {
   mostrarLoader(); //
  e.preventDefault();
  const id = document.getElementById("edit-id").value;
  const datosActualizados = {
    nombres: document.getElementById("edit-nombre").value,
    apellidos: document.getElementById("edit-apellido").value,
    cedula: document.getElementById("edit-cedula").value,
    sexo: document.getElementById("edit-sexo").value,
    edad: document.getElementById("edit-edad").value,
    celular: document.getElementById("edit-celular").value,
    correo: document.getElementById("edit-correo").value
  };

  try {
    const resp = await fetch(`/api/pacientes/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(datosActualizados)
    });
    ocultarLoader();
    if (resp.ok) {
      modal.style.display = "none";
      mostrarMensaje("✅ Información actualizada exitosamente");
      setTimeout(() => location.reload(), 2000);
      console.log(await resp.text());

    } else {
      mostrarMensaje("❌ Error al actualizar paciente", true);
      console.log(await resp.text());

    }
  } catch (err) {
    console.error("Error:", err);
  }
});

btnEliminar.addEventListener("click", async () => {
  if (!pacienteActual) return;
  const confirmar = confirm(`¿Seguro que deseas eliminar a ${pacienteActual.nombres}?`);
  if (!confirmar) return;
   mostrarLoader();

  try {
    const resp = await fetch(`/api/pacientes/${pacienteActual.id}`, {
      method: "DELETE"
    });

    ocultarLoader();

    if (resp.ok) {
      modal.style.display = "none";
      mostrarMensaje("🗑️ Paciente eliminado correctamente");
      setTimeout(() => location.reload(), 2000);
    } else {
      mostrarMensaje("❌ Error al eliminar paciente", true);
    }
  } catch (err) {
    console.error("Error:", err);
  }
});

function mostrarMensaje(texto, error = false) {
  mensajeExito.style.background = error ? "#dc3545" : "#4CAF50";
  mensajeExito.innerText = texto;
  mensajeExito.style.display = "block";
  setTimeout(() => mensajeExito.style.display = "none", 3000);
}

let pacientes = []; // se llenará al cargar desde el backend
const pacientesContainer = document.getElementById('pacientes-list');
const searchInput = document.querySelector('.search-bar input');
let filtroActivo = "recientes";

// 🟢 Escuchar las burbujas
const burbujas = document.querySelectorAll(".filtro-burbuja");
burbujas.forEach(b => {
  b.addEventListener("click", () => {
    burbujas.forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    filtroActivo = b.dataset.filtro;
    aplicarFiltros();
  });
});

// 🔍 Escuchar búsqueda
searchInput.addEventListener("input", aplicarFiltros);

// 🔥 Función para aplicar búsqueda + ordenamiento
function aplicarFiltros() {
  let lista = [...pacientes];
  const term = searchInput.value.toLowerCase();

  // 🔍 Filtrar por búsqueda
  if (term) {
    lista = lista.filter(p =>
      p.nombres.toLowerCase().includes(term) ||
      p.apellidos.toLowerCase().includes(term) ||
      p.cedula.includes(term) ||
      p.correo.toLowerCase().includes(term)
    );
  }

  // 🔄 Ordenar según filtroActivo
  lista.sort((a, b) => {
    if (filtroActivo === "az") return a.nombres.localeCompare(b.nombres);
    if (filtroActivo === "za") return b.nombres.localeCompare(a.nombres);
    if (filtroActivo === "recientes") return new Date(b.created_at) - new Date(a.created_at);
    if (filtroActivo === "antiguos") return new Date(a.created_at) - new Date(b.created_at);
    return 0;
  });

  renderPacientes(lista);
}

// 🖼️ Función para renderizar pacientes
function renderPacientes(lista) {
  pacientesContainer.innerHTML = "";
  if (lista.length === 0) {
    pacientesContainer.innerHTML = "<p>No hay pacientes que coincidan con la búsqueda.</p>";
    return;
  }
  lista.forEach(p => {
    const div = document.createElement("div");
    div.classList.add("paciente-item");
    div.innerHTML = `
      <p><strong>Nombre:</strong> ${p.nombres} ${p.apellidos}</p>
      <p><strong>Cédula:</strong> ${p.cedula}</p>
      <p><strong>Sexo:</strong> ${p.sexo}</p>
      <p><strong>Edad:</strong> ${p.edad}</p>
      <p><strong>Celular:</strong> ${p.celular}</p>
      <p><strong>Correo:</strong> ${p.correo}</p>
    `;
    div.addEventListener("click", () => mostrarModal(p));
    pacientesContainer.appendChild(div);
  });
}

// ✅ Sobrescribimos tu fetch existente para llenar pacientes y renderizar
document.addEventListener('DOMContentLoaded', async () => {
  mostrarLoader();
  try {
    const resp = await fetch('/api/pacientes');
    pacientes = await resp.json();
    aplicarFiltros(); // muestra con el filtro por defecto
  } catch (err) {
    console.error("Error cargando pacientes", err);
  } finally {
    ocultarLoader();
  }
});



</script>
</body>
</html>
